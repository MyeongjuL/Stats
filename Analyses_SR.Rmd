---
title: "Thesis analyses: Speaking Rate"
author: "Myeongju Lee"
output: html_document
---
install.packages(Rmisc)
install.packages("data.table")
install.packages("stringr")
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")
install.packages("readxl")
install.packages("Matrix")
install.packages("lme4")
install.packages("simr")
options(scipen = 999)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(Rmisc))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(readxl))
options(scipen=999)
```

# Preprocessing
## Loading data set
```{r pressure, echo=FALSE}
df_SR <- read.csv("SpeakingRate.csv")
```

### Summaries of the data set 
```{r}
summary(df_SR)
```

### Density plot of the data set
```{r}
plot(density(df_SR$SR, na.rm=TRUE))
```


## Separating data set into subsets
```{r}
df_SR_main <- subset(df_SR, QuestionNum %% 10 == 0)
df_SR_folu <- subset(df_SR, QuestionNum %% 10 != 0)
```

### Summaries of the subsets 
```{r}
summary(df_SR_main)
summary(df_SR_folu)
```

### Kolmogorov–Smirnov test to compare distributions of the subsets
```{r}
ks.test(df_SR_main$SR, df_SR_folu$SR)
```

### Visualizing densities of the subsets
```{r}
max_y <- max(density(df_SR_main$SR)$y, density(df_SR_folu$SR)$y) * 1.1
max_x <- max(max(df_SR_main$SR), max(df_SR_folu$SR)) * 1.1

plot(density(df_SR_main$SR), col="red", main="Density comparison", ylim=c(0, max_y), xlim=c(0, max_x), xlab("Speaking Rate (syl/s)"))
lines(density(df_SR_folu$SR), col="blue")
legend("topright", legend=c("Main", "Follow-up"), col=c("red","blue"), lty=1)
```


## Cleaning outliers 1: in each subset per condition using *participants'* mean and sd
### How many responses per condition
```{r}
table(df_SR_main$ResponseCond)
table(df_SR_folu$ResponseCond)
```

### Setting low and high thresholds in the main subset
```{r}
SR_main_SE <- summarySE(df_SR_main, measurevar = "SR", groupvars = c("ParticipantID", "ResponseCond"), na.rm=T)

SR_main_SE$Low = SR_main_SE$SR - 2*SR_main_SE$sd
SR_main_SE$High = SR_main_SE$SR + 2*SR_main_SE$sd

SR_main_SE <- SR_main_SE[,c(1,2,8,9)]

df_SR_main = merge(df_SR_main, SR_main_SE)
```

### Setting low and high thresholds in the follow-up subset
```{r}
SR_folu_SE <- summarySE(df_SR_folu, measurevar = "SR", groupvars = c("ParticipantID", "ResponseCond"), na.rm=T)

SR_folu_SE$Low = SR_folu_SE$SR - 2*SR_folu_SE$sd
SR_folu_SE$High = SR_folu_SE$SR + 2*SR_folu_SE$sd

SR_folu_SE <- SR_folu_SE[,c(1,2,8,9)]

df_SR_folu = merge(df_SR_folu, SR_folu_SE)
```

### How many low outliers in the main subset
```{r}
length(df_SR_main[(df_SR_main$SR < df_SR_main$Low),]$SR)
length(df_SR_main[(df_SR_main$SR < df_SR_main$Low),]$SR)/length(df_SR_main$SR)
```

### How many low outliers in the follow-up subset
```{r}
length(df_SR_folu[(df_SR_folu$SR < df_SR_folu$Low),]$SR)
length(df_SR_folu[(df_SR_folu$SR < df_SR_folu$Low),]$SR)/length(df_SR_folu$SR)
```

### How many high outliers in the main subset
```{r}
length(df_SR_main[(df_SR_main$SR > df_SR_main$High),]$SR)
length(df_SR_main[(df_SR_main$SR > df_SR_main$High),]$SR)/length(df_SR_main$SR)
```

### How many high outliers in the follow-up subset
```{r}
length(df_SR_folu[(df_SR_folu$SR > df_SR_folu$High),]$SR)
length(df_SR_folu[(df_SR_folu$SR > df_SR_folu$High),]$SR)/length(df_SR_folu$SR)
```

### Removing Speaking Rate outliers in each subset
```{r}
df_SR_main <- df_SR_main[(df_SR_main$SR <= df_SR_main$High & df_SR_main$SR >= df_SR_main$Low), ]
df_SR_folu <- df_SR_folu[(df_SR_folu$SR <= df_SR_folu$High & df_SR_folu$SR >= df_SR_folu$Low), ]
```

### Summaries of the subsets after removing outliers
```{r}
summary(df_SR_main)
summary(df_SR_folu)
```

### How many responses per condition after removing outliers 1
```{r}
table(df_SR_main$ResponseCond)
table(df_SR_folu$ResponseCond)
```

### Kolmogorov–Smirnov test to compare distributions of the subsets after removing outliers
```{r}
ks.test(df_SR_main$SR, df_SR_folu$SR)
```

### Visualizing densities of the subsets after removing outliers
```{r}
max_y2 <- max(density(df_SR_main$SR)$y, density(df_SR_folu$SR)$y) * 1.1

plot(density(df_SR_main$SR), col="red", main="Density comparison", ylim=c(0, max_y2), xlab("Speaking Rate (syl/s)"))
lines(density(df_SR_folu$SR), col="blue")
legend("topright", legend=c("Main", "Follow-up"), col=c("red","blue"), lty=1)
```


## Cleaning outliers 2: in each subset per condition using *overarching* mean and sd
### Setting low and high thresholds in the main subset
```{r}
SR_main_all_SE <- summarySE(df_SR_main, measurevar = "SR", groupvars = c("ResponseCond"), na.rm=T)

SR_main_all_SE$Low_all = SR_main_all_SE$SR - 2*SR_main_all_SE$sd
SR_main_all_SE$High_all = SR_main_all_SE$SR + 2*SR_main_all_SE$sd

SR_main_all_SE <- SR_main_all_SE[,c(1,7,8)]

df_SR_main = merge(df_SR_main, SR_main_all_SE)
```

### Setting low and high thresholds in the follow-up subset
```{r}
SR_folu_all_SE <- summarySE(df_SR_folu, measurevar = "SR", groupvars = c("ResponseCond"), na.rm=T)

SR_folu_all_SE$Low_all = SR_folu_all_SE$SR - 2*SR_folu_all_SE$sd
SR_folu_all_SE$High_all = SR_folu_all_SE$SR + 2*SR_folu_all_SE$sd

SR_folu_all_SE <- SR_folu_all_SE[,c(1,7,8)]

df_SR_folu = merge(df_SR_folu, SR_folu_all_SE)
```

### How many low outliers in the main subset
```{r}
length(df_SR_main[(df_SR_main$SR < df_SR_main$Low_all),]$SR)
length(df_SR_main[(df_SR_main$SR < df_SR_main$Low_all),]$SR)/length(df_SR_main$SR)
```

### How many low outliers in the follow-up subset
```{r}
length(df_SR_folu[(df_SR_folu$SR < df_SR_folu$Low_all),]$SR)
length(df_SR_folu[(df_SR_folu$SR < df_SR_folu$Low_all),]$SR)/length(df_SR_folu$SR)
```

### How many high outliers in the main subset
```{r}
length(df_SR_main[(df_SR_main$SR > df_SR_main$High_all),]$SR)
length(df_SR_main[(df_SR_main$SR > df_SR_main$High_all),]$SR)/length(df_SR_main$SR)
```

### How many high outliers in the follow-up subset
```{r}
length(df_SR_folu[(df_SR_folu$SR > df_SR_folu$High_all),]$SR)
length(df_SR_folu[(df_SR_folu$SR > df_SR_folu$High_all),]$SR)/length(df_SR_folu$SR)
```

### Removing Speaking Rate outliers using overarching mean and sd in each subset
```{r}
df_SR_main <- df_SR_main[(df_SR_main$SR <= df_SR_main$High_all & df_SR_main$SR >= df_SR_main$Low_all), ]
df_SR_folu <- df_SR_folu[(df_SR_folu$SR <= df_SR_folu$High_all & df_SR_folu$SR >= df_SR_folu$Low_all), ]
```

### Summaries of the subsets after removing outliers using overarching mean and sd
```{r}
summary(df_SR_main)
summary(df_SR_folu)
```

### How many responses per condition after removing outliers 1
```{r}
table(df_SR_main$ResponseCond)
table(df_SR_folu$ResponseCond)
```

### Kolmogorov–Smirnov test to compare distributions of the subsets after removing outliers using overarching mean and sd
```{r}
ks.test(df_SR_main$SR, df_SR_folu$SR)
```

### Visualizing densities of the subsets after removing outliers using overarching mean and sd
```{r}
max_y3 <- max(density(df_SR_main$SR)$y, density(df_SR_folu$SR)$y) * 1.1

plot(density(df_SR_main$SR), col="red", main="Density comparison", ylim=c(0, max_y3), xlab("Speaking Rate (syl/s)"))
lines(density(df_SR_folu$SR), col="blue")
legend("topright", legend=c("Main", "Follow-up"), col=c("red","blue"), lty=1)
```


## Speaking Rate(in each subset): means
```{r}
summarySE(df_SR_main, measurevar = "SR", groupvars = c("ResponseCond"), na.rm = T)
summarySE(df_SR_folu, measurevar = "SR", groupvars = c("ResponseCond"), na.rm = T)
```


## Putting the subsets together again after cleaning outliers
```{r}
df_SR_main$QuestionType <- "Main"
df_SR_folu$QuestionType <- "FollowUp"
df_SR_main_folu <- rbind(df_SR_main, df_SR_folu)
```

## Speaking Rate (together): means
```{r}
summarySE(df_SR_main_folu, measurevar = "SR", groupvars = c("ResponseCond"), na.rm = T)
```

## Checking distributions of the merged data frame after cleaning outliers
```{r}
plot(density(df_SR_main_folu$SR))

hist(df_SR_main_folu$SR)

qqnorm(df_SR_main_folu$SR); qqline(df_SR_main_folu$SR)
```


## Adding Item ID for correlation tests later
```{r}
df_SR_main_folu$ItemID <- df_SR_main_folu$QuestionNum %/% 10
```


## Coding the relevant columns as the type "factor"
```{r}
factors <- c("ParticipantID", "ResponseCond", "QuestionNum", "QuestionType", "ItemID")
df_SR_main_folu[factors] <- lapply(df_SR_main_folu[factors], factor)

summary(df_SR_main_folu)
```



# Plotting data of Speaking Rate
## Merged set
```{r}
plot_SR <- summarySE(df_SR_main_folu, measurevar = "SR", groupvars = c("ResponseCond"), na.rm=T)

ggplot(plot_SR, aes(x = ResponseCond, y = SR, fill = ResponseCond)) +
  geom_col(position = "dodge", width = 0.6) +
  theme_bw() +
  ylab("Speaking Rate (syl/s)") +
  xlab("Response Condition") +
  ggtitle("Speaking Rate by Response Condition") +
  scale_x_discrete(labels=c("T"="Truthful", "D"="Deceptive")) +
  geom_errorbar(aes(ymin=SR-se, ymax=SR+se), linewidth=.5, width=.2, position=position_dodge(0.6)) +
  scale_fill_manual(values = c("D"="#FF7C80", "T"="#8ED973")) +
  theme(legend.position = "none", axis.text = element_text(size = 12), axis.title = element_text(size = 14), 
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20))) + 
  coord_cartesian(ylim = c(3, NA))
```

## Subset of responses to Main questions
```{r}
plot_SR_main <- summarySE(df_SR_main, measurevar = "SR", groupvars = c("ResponseCond"), na.rm=T)

ggplot(plot_SR_main, aes(x = ResponseCond, y = SR, fill = ResponseCond)) +
  geom_col(position = "dodge", width = 0.6) +
  theme_bw() +
  ylab("Speaking Rate (syl/s)") +
  xlab("Response Condition") +
  ggtitle("Speaking Rate after Main Question by Response Condition") +
  scale_x_discrete(labels=c("T"="Truthful", "D"="Deceptive")) +
  geom_errorbar(aes(ymin=SR-se, ymax=SR+se), linewidth=.5, width=.2, position=position_dodge(0.6)) +
  scale_fill_manual(values = c("D"="#FF7C80", "T"="#8ED973")) +
  theme(legend.position = "none", axis.text = element_text(size = 12), axis.title = element_text(size = 14), 
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20))) + 
  coord_cartesian(ylim = c(3, NA))
```


## Subset of responses to Follow-up questions
```{r}
plot_SR_folu <- summarySE(df_SR_folu, measurevar = "SR", groupvars = c("ResponseCond"), na.rm=T)

ggplot(plot_SR_folu, aes(x = ResponseCond, y = SR, fill = ResponseCond)) +
  geom_col(position = "dodge", width = 0.6) +
  theme_bw() +
  ylab("Speaking Rate (syl/s)") +
  xlab("Response Condition") +
  ggtitle("Speaking Rate after Follow-up Question by Response Condition") +
  scale_x_discrete(labels=c("T"="Truthful", "D"="Deceptive")) +
  geom_errorbar(aes(ymin=SR-se, ymax=SR+se), linewidth=.5, width=.2, position=position_dodge(0.6)) +
  scale_fill_manual(values = c("D"="#FF7C80", "T"="#8ED973")) +
  theme(legend.position = "none", axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20))) +
  coord_cartesian(ylim = c(3, NA))
```


## Subsets together
```{r}
plot_SR_main_folu <- summarySE(df_SR_main_folu, measurevar = "SR", groupvars = c("ResponseCond", "QuestionType"), na.rm=T)

plot_SR_main_folu$QuestionType <- factor(plot_SR_main_folu$QuestionType, levels = c("Main", "FollowUp"))

ggplot(plot_SR_main_folu, aes(x = QuestionType, y = SR, fill = ResponseCond)) +
  geom_col(position = "dodge", width = 0.8) +
  theme_bw() +
  ylab("Speaking Rate (syl/s)") +
  xlab("Question Type") +
  ggtitle("Speaking Rate by Question Type and Response Condition") +
  scale_x_discrete(labels = c("Main" = "Main Question", "FollowUp" = "Follow-up Question")) +
  geom_errorbar(aes(ymin=SR - se, ymax=SR + se), linewidth =.5, width =.2, position = position_dodge(0.8)) +
  scale_fill_manual(values = c("D" = "#FF7C80", "T" = "#8ED973"), labels = c("T" = "Truthful", "D" = "Deceptive")) +
  theme(legend.title = element_blank(), axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20))) +
  coord_cartesian(ylim = c(3, NA))
```


## Saving the final data frame
```{r}
write.csv(df_SR_main_folu, "PreprocessedSR.csv")
write.csv(df_SR_main, "PreprocessedSR_main.csv")
write.csv(df_SR_folu, "PreprocessedSR_folu.csv")
```



# Analysis
```{r}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages(library(ez))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(simr))
```


## Preparing
### Embeding the contrasts: -.5 and .5. for 2 level factors (contrast coding)
```{r}
contrasts(df_SR_main_folu$ResponseCond) <- c(-.5,.5)

mm_SR_main_folu <- model.matrix(~ResponseCond, df_SR_main_folu)
df_SR_main_folu$ResponseCond1 <- mm_SR_main_folu[,2]
```


## LMM
1 - intercept
ResponseCond1 - D vs. T

The critical t value > |2|

### Maximum model without correlation
```{r}
Model_SR = lmer(SR ~ 1 + ResponseCond1 + 
                  (1 + ResponseCond1 || ParticipantID) + 
                  (1 + ResponseCond1 || QuestionNum) + 
                  (1 + ResponseCond1 || QuestionType),
                REML=FALSE,
                data=df_SR_main_folu,
                control=lmerControl(calc.derivs=FALSE),
                na.action=na.omit)

summary(rePCA(Model_SR))
summary(Model_SR)
```

### Reduced model with correlations: Final model
```{r}
Model_SR_Corr = lmer(SR ~ 1 + ResponseCond1 + 
                  (1 + ResponseCond1 | ParticipantID) + 
                  (1 | QuestionNum) + 
                  (1 | QuestionType),
                REML=FALSE,
                data=df_SR_main_folu,
                control=lmerControl(calc.derivs=FALSE),
                na.action=na.omit)

summary(rePCA(Model_SR_Corr))
summary(Model_SR_Corr)
```

### Checking model residuals
```{r}
plot(fitted(Model_SR_Corr), resid(Model_SR_Corr))
abline(h=0, col="red")

hist(resid(Model_SR_Corr))
qqnorm(resid(Model_SR_Corr)); qqline(resid(Model_SR_Corr))
```


## Correlation between responses to Main & Follow-up questions per Participant
### Creating a mean data frame
```{r}
df_SR_mean_part <- summarySE(df_SR_main_folu, measurevar = "SR", groupvars = c("ParticipantID", "QuestionType"), na.rm = T)
df_SR_mean_part <- df_SR_mean_part[, c("ParticipantID", "QuestionType", "SR")]
df_SR_mean_part <- pivot_wider(df_SR_mean_part, names_from = QuestionType, values_from = SR)
```

### Visualizing the data frame before correlation tests
```{r}
ggplot(df_SR_mean_part, aes(x = Main, y = FollowUp)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, level = 0.95, color = "red", fill = "#fcbba1") +
  theme_bw() +
  labs(x = "After Main Questions",
       y = "After Follow-up Questions",
       title = "Mean Speaking Rate per Participant") +
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20)))
```

### Pearson (using data) & Spearman (using ranks) tests
```{r}
cor.test(df_SR_mean_part$Main, df_SR_mean_part$FollowUp, method = "pearson")
cor.test(df_SR_mean_part$Main, df_SR_mean_part$FollowUp, method = "spearman")
```


## Correlation between responses to Main & Follow-up questions per Item
### Creating a mean data frame
```{r}
df_SR_mean_item <- summarySE(df_SR_main_folu, measurevar = "SR", groupvars = c("ItemID", "QuestionType"), na.rm = T)
df_SR_mean_item <- df_SR_mean_item[, c("ItemID", "QuestionType", "SR")]
df_SR_mean_item <- pivot_wider(df_SR_mean_item, names_from = QuestionType, values_from = SR)
```

### Visualizing the data frame before correlation tests
```{r}
ggplot(df_SR_mean_item, aes(x = Main, y = FollowUp)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, level = 0.95, color = "red", fill = "#fcbba1") +
  theme_bw() +
  labs(x = "After Main Questions",
       y = "After Follow-up Questions",
       title = "Mean Speaking Rate per Item") +
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r = 15)), axis.title.x = element_text(margin = margin(t = 10)),
        plot.title = element_text(size = 16, margin = margin(b = 20)))
```

### Pearson (using data) & Spearman (using ranks) tests
```{r}
cor.test(df_SR_mean_item$Main, df_SR_mean_item$FollowUp, method = "pearson")
cor.test(df_SR_mean_item$Main, df_SR_mean_item$FollowUp, method = "spearman")
```

